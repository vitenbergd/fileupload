## What is Fileupload?
`Fileupload` accepts files via `HTTP POST` requests and stores them in temporary location.

## Dependencies

Build dependencies:
* openjdk-11
* javalin (3.13.10)
* slf4j-simple (1.7.30)
* jackson-databind (2.10.5)
* picocli (4.6.1)
* picocli-codegen (4.6.1)

Tests dependencies:
* assertj-core (3.11.1)
* unirest-java (3.11.09)
* unit-jupiter-api (5.7.0)
* junit-jupiter-engine (5.7.0)

## Build
To build fatJar run:
```  
./gradlew clean  
./gradlew fatJar  
```  
Jar file can be found here: `build/lib/FileUpload-<version>.jar`
To build docker container  [`jib-gradle-plugin`](https://github.com/GoogleContainerTools/jib/tree/master/jib-gradle-plugin) is used with [`gcr.io/distroless/java:11`](https://github.com/GoogleContainerTools/distroless/blob/main/java/README.md) as base image, i.e.:
1. build and push image to specific registry:
```
./gradlew jib --image=fileupload:0.0.1
# GCP
./gradlew jib --image='gcr.io/my-gcp-project/fileupload:0.0.1'
# AWS
./gradlew jib --image='aws_account_id.dkr.ecr.region.amazonaws.com/fileupload:0.0.1'
```  
2. build and load to local docker daemon:
```
./gradlew jibDockerBuild --image=fileupload:0.0.1
```
3. build tarball:
```
./gradlew jibBuildTar --image=fileupload:0.0.1
```
tarball default location is:  `build/jib-image.tar`
load tarball to docker daemon:
```
docker load < build/jib-image.tar
```
## Run
To run with default settings execute:
```  
java -jar build/lib/FileUpload-<version>.jar  
```
To run in docker:
```
docker run -p 8080:8080 -ti --rm -u 1001 fileupload:0.0.1
```
## Run tests
Couple of functional test are implemented, run:
```
./gradlew test
```
## Usage

```  
Usage: fileupload [-hV] [-f=<uploadFieldName>] [-m=<uploadMaxFileSize>]
                  [-p=<appPort>] [-u=<uploadPath>]
Uploads file to temporary directory via POST request
  -f, --field-name=<uploadFieldName>
                  Upload request file field name
                  (default: 'files', ENV var: FU_UPLOAD_PARAM_NAME)
  -h, --help      Show this help message and exit.
  -m, --max-size=<uploadMaxFileSize>
                  Upload request max size in bytes
                  (default: '20971520', ENV var: FU_UPLOAD_MAX_FILE_SIZE)
  -p, --http-port=<appPort>
                  HTTP port to bind
                  (default: '8080', ENV var: FU_APP_PORT)
  -u, --upload-path=<uploadPath>
                  POST request handler path
                  (default: 'upload', ENV var: FU_UPLOAD_PATH)
  -V, --version   Print version information and exit.
```  
## Example
`Fileupload` is ment to be used with `curl -F "files=@<myfile>"`  ( `multipart/form-data`  content type, [RFC2388](https://datatracker.ietf.org/doc/html/rfc2388)), i.e:

1. Upload single file:
```
echo "Hello" > myfile
curl -F "files=@myfile" localhost:8080/upload
```
2. Upload multiple files:
```
echo "Hello1" > myfile1 && echo "Hello2" > myfile2
curl -F "files=@myfile1" -F "files=@myfile2" localhost:8080/upload
```
## Response
Successful response will look like:
 ```
$ curl -v -s -F "files=@myfile" localhost:8080/upload | jq -r
 *   Trying 127.0.0.1:8080...
* Connected to localhost (127.0.0.1) port 8080 (#0)
> POST /upload HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/7.78.0
> Accept: */*
> Content-Length: 205
> Content-Type: multipart/form-data; boundary=------------------------8e8186029bccee9d
>
} [205 bytes data]
* We are completely uploaded and fine
* Mark bundle as not supporting multiuse
< HTTP/1.1 201 Created
< Date: Sun, 22 Aug 2021 10:47:40 GMT
< Server: Javalin
< Content-Type: application/json
< Content-Length: 113
<
{ [113 bytes data]
* Connection #0 to host localhost left intact
[
  {
    "originalFileName": "myfile",
    "outFilePath": "/tmp/fileupload-1835953498374785360.tmp",
    "uploadFieldName": "files"
  }
]
```
1. `HTTP` code is `201 Created`
2. response body is `JSON` list of objects with 3 fields:
* `originalFileName` - file name defined in `curl` command (`curl -F "files=@<file name>`)
* `outFilePath` - output file generated by `Fileupload`
* `uploadFieldName` - files field name  defined in `curl` command (`curl -F "<field name>=@myfile`)

## Implementation details
- `curl -F`(`multipart/form-data`) upload method was chosen due to support of multiple file upload, named field (providing some kind of namespacing), native ability to set file name, ability to be used via HTML forms
- files uploaded inside different field name are ignored
- empty files are skipped (with some info logged
- file in temporary location are created with [File.createTempFile](https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#createTempFile%28java.lang.String,%20java.lang.String,%20java.nio.file.attribute.FileAttribute...%29), so temporary directory setting is defined via `java.io.tmpdir` flag (but it's not recommended to change it)
- if files are stored in `/tmp` directory they can be wiped out after host restart (depends on the host setup)
- to obtain error response in `JSON` format client should be able to accept `JSON`, i.e.:
```
curl -H "Accept: application/json" -F "files=@myfile" localhost:8080/upload
```
- max upload size has naive implementation via comparison of `Content-Length` header wich is not strictly required from client
-  `slf4j-simple` logger default config path - `src/main/resources/simplelogger.properties`